var RPCWebSocket=function(){"use strict";function e(r){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(r)}function r(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function t(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function i(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function u(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?i(Object(t),!0).forEach((function(r){o(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function s(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),r&&a(e,r)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,r){return(a=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function f(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function l(e,r,t){return(l=f()?Reflect.construct:function(e,r,t){var n=[null];n.push.apply(n,r);var o=new(Function.bind.apply(e,n));return t&&a(o,t.prototype),o}).apply(null,arguments)}function h(e){var r="function"==typeof Map?new Map:void 0;return(h=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,n)}function n(){return l(e,arguments,c(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),a(n,e)})(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e,r){return!r||"object"!=typeof r&&"function"!=typeof r?p(e):r}function d(e,r,t){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,r,t){var n=function(e,r){for(;!Object.prototype.hasOwnProperty.call(e,r)&&null!==(e=c(e)););return e}(e,r);if(n){var o=Object.getOwnPropertyDescriptor(n,r);return o.get?o.get.call(t):o.value}})(e,r,t||e)}function v(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var t=[],n=!0,o=!1,i=void 0;try{for(var u,s=e[Symbol.iterator]();!(n=(u=s.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw i}}return t}(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}for(var w=function(e,r){return e(r={exports:{}},r.exports),r.exports}((function(e){var r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(r){var t=new Uint8Array(16);e.exports=function(){return r(t),t}}else{var n=new Array(16);e.exports=function(){for(var e,r=0;r<16;r++)0==(3&r)&&(e=4294967296*Math.random()),n[r]=e>>>((3&r)<<3)&255;return n}}})),m=[],g=0;g<256;++g)m[g]=(g+256).toString(16).substr(1);var b=function(e,r){var t=r||0,n=m;return[n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]]].join("")};var O=function(e,r,t){var n=r&&t||0;"string"==typeof e&&(r="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||w)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r)for(var i=0;i<16;++i)r[n+i]=o[i];return r||b(o)},E="Parse error",j=-32700,R="Invalid request",k=-32600,S="Method not found",_=-32601,P="Invalid params",q=-32602,C="Internal error",N=-32603,A=function(){function e(t){r(this,e),this.jsonrpc=t}return n(e,[{key:"toJSON",value:function(){return{jsonrpc:this.jsonrpc}}}]),e}(),x=function(e){function t(e,n,o){var i;return r(this,t),(i=y(this,c(t).call(this,e))).method=n,i.params=o,i}return s(t,e),n(t,[{key:"toJSON",value:function(){return u({},d(c(t.prototype),"toJSON",this).call(this),{method:this.method,params:this.params})}}]),t}(A),J=function(e){function t(e,n,o,i){var u;return r(this,t),(u=y(this,c(t).call(this,e,n,o))).id=i,u}return s(t,e),n(t,[{key:"toJSON",value:function(){return u({},d(c(t.prototype),"toJSON",this).call(this),{id:this.id})}}]),t}(x),I=function(e){function t(e,n,o,i){var u;return r(this,t),(u=y(this,c(t).call(this,e))).field=n,u.value=o,u.id=i,u}return s(t,e),n(t,[{key:"toJSON",value:function(){var e;return u({},d(c(t.prototype),"toJSON",this).call(this),(o(e={},this.field,this.value),o(e,"id",this.id),e))}}]),t}(A),M=function(e){function t(e,n,o){return r(this,t),y(this,c(t).call(this,e,"error",n,o))}return s(t,e),t}(I),T=function(e){function t(e,n,o){return r(this,t),y(this,c(t).call(this,e,"result",n,o))}return s(t,e),t}(I),D=function(e,r){return e===r},L=function(r,t){return D(e(r),t)},V=function(e){return null===e},F=function(e){return L(e,"string")},W=function(e){return L(e,"object")&&!V(e)},U=function(e){return D(e,void 0)},z=function(e){if(F(e)&&e.length>0)return!0;if(Number.isInteger(e))return!0;if(V(e))return!0;throw new Error("id field in not valid, expect string, int or null")},B=function(e){var r=e.method,t=e.params;if(!F(r))throw new Error("method field is not a string");if(r.length<1)throw new Error("method field is required");if(!U(t)&&!W(t)&&!Array.isArray(t))throw new Error("params field in not valid, array or object expected");return!0},G={error:function(e){if(z(e.id),!W(e.error))throw new Error("error field is required");if(!Number.isInteger(e.error.code))throw new Error("error.code field is required, int");if(!F(e.error.message))throw new Error("error.message field is required, string");return!0},message:function(e){if(!W(e))throw new Error("message is not an object");var r=e.jsonrpc;if(!D(r,"2.0"))throw new Error("jsonrpc field is not valid, 2.0 version expected");return!0},request:function(e){return B(e),z(e.id)},response:function(e){if(z(e.id),U(e.result))throw new Error("result field is required");return!0},notification:B},H=function(e){G.message(e);var r=function(e){var r=e.method,t=e.result,n=e.error,o=e.id;return r&&o?"request":r?"notify":t&&o?"response":n&&o?"error":null}(e);switch(r){case"request":return G.request(e),[r,new J(e.jsonrpc,e.method,e.params,e.id)];case"notify":return G.notification(e),[r,new x(e.jsonrpc,e.method,e.params)];case"response":return G.response(e),[r,new T(e.jsonrpc,e.result,e.id)];case"error":return G.error(e),[r,new M(e.jsonrpc,e.error,e.id)];default:throw new Error("unexpected type")}},K=function(e){function t(e,n,o){var i;return r(this,t),(i=y(this,c(t).call(this,n))).code=e,i.data=o,i.name=i.constructor.name,Error.captureStackTrace(p(i),i.constructor),i}return s(t,e),n(t,[{key:"toJSON",value:function(){return{code:this.code,data:this.data,message:this.message}}}]),t}(h(Error)),Q=function(e){function t(e){return r(this,t),y(this,c(t).call(this,N,C,e))}return s(t,e),t}(K),X=function(e){function t(e){return r(this,t),y(this,c(t).call(this,q,P,e))}return s(t,e),t}(K),Y=function(e){function t(e){return r(this,t),y(this,c(t).call(this,k,R,e))}return s(t,e),t}(K),Z=function(e){function t(e){return r(this,t),y(this,c(t).call(this,_,S,e))}return s(t,e),t}(K),$=function(e){function t(e){return r(this,t),y(this,c(t).call(this,j,E,e))}return s(t,e),t}(K),ee=function(){function e(){r(this,e),this._handlers={}}return n(e,[{key:"_has",value:function(e){return Array.isArray(this._handlers[e])}},{key:"on",value:function(e,r){this._has(e)||(this._handlers[e]=[]),this._handlers[e].push(r)}},{key:"emit",value:function(e){for(var r=arguments.length,t=new Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];this._has(e)&&this._handlers[e].forEach((function(e){e.apply(void 0,t)}))}},{key:"remove",value:function(e,r){this._has(e)&&(this._handlers[e]=this._handlers[e].filter((function(e){return e!==r})))}}]),e}();var re={CreateError:function(e,r){return new M("2.0",r,e)},CreateNotify:function(e,r){return new x("2.0",e,r)},CreateResponse:function(e,r){return new T("2.0",r,e)},CreateRequest:function(e,r,t){return new J("2.0",r,t,e)}},te=function(e){function t(){var e,n;r(this,t);for(var i=arguments.length,u=new Array(i),s=0;s<i;s++)u[s]=arguments[s];return o(p(n=y(this,(e=c(t)).call.apply(e,[this].concat(u)))),"onMessage",(function(e){var r;try{r=JSON.parse(e)}catch(e){n.onMessageCatch(e)}Array.isArray(r)||(r=[r]),r.forEach((function(e){try{var r=v(H(e),2),t=r[0],o=r[1];n.emit(t,o)}catch(r){n.onMessageCatch(r,e)}}))})),n}return s(t,e),n(t,[{key:"onMessageCatch",value:function(e,r){var t=null;try{G.message(r)&&G.id(r.id)&&(t=r.id)}catch(e){}var n=re.CreateError(t,new $(e.message));this.emit("error",n)}}]),t}(ee),ne=["open","close","error","message"];return function(e){function t(){r(this,t);for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];return y(this,c(t).call(this,l(WebSocket,n)))}return s(t,e),t}(function(e){function t(e){var n;return r(this,t),o(p(n=y(this,c(t).call(this))),"_onReceievError",(function(e){null!==e.id?n.pendings[e.id]&&(n.pendings[e.id].reject(e.error),delete n.pendings[e.id]):n.emit("error",e,p(n))})),o(p(n),"_onReceievResponse",(function(e){n.pendings[e.id]&&(n.pendings[e.id].resolve(e.result),delete n.pendings[e.id])})),o(p(n),"_onReceievNotify",(function(e){n.emit("request",e,p(n))})),o(p(n),"_onReceievRequest",(function(e){n.emit("request",e,p(n))})),n.ws=e,n.pendings={},n.receiver=new te,n.receiver.on("error",n._onReceievError),n.receiver.on("request",n._onReceievRequest),n.receiver.on("response",n._onReceievResponse),n.receiver.on("notify",n._onReceievNotify),n.ws.on("message",n.receiver.onMessage),n}return s(t,e),n(t,[{key:"send",value:function(e){this.ws.send(JSON.stringify(e))}},{key:"respond",value:function(e,r){this.send(re.CreateResponse(e,r))}},{key:"throw",value:function(e,r,t,n){this.throwError(e,new K(r,t,n))}},{key:"throwError",value:function(e,r){this.send(re.CreateError(e,r))}},{key:"throwInternalError",value:function(e,r){this.throwError(e,new Q(r))}},{key:"throwInvalidParams",value:function(e,r){this.throwError(e,new X(r))}},{key:"throwInvalidRequest",value:function(e,r){this.throwError(e,new Y(r))}},{key:"throwNotFound",value:function(e,r){this.throwError(e,new Z(r))}},{key:"throwParseError",value:function(e,r){this.throwError(e,new $(r))}},{key:"notify",value:function(e,r){this.send(re.CreateNotify(e,r))}},{key:"request",value:function(e,r){var t=O();return Promise.race([this.createRequest(t,e,r),this.createTimeout(t,2500)])}},{key:"createRequest",value:function(e,r,t){var n=this;return new Promise((function(o,i){n.pendings[e]={resolve:o,reject:i},n.send(re.CreateRequest(e,r,t))}))}},{key:"createTimeout",value:function(e,r){var t=this;return function(e){return new Promise((function(r){setTimeout(r,e)}))}(r).then((function(){t._onReceievError(re.CreateError(e,new Q("timeout")))}))}},{key:"on",value:function(){this.addEventListener.apply(this,arguments)}},{key:"remove",value:function(){this.removeEventListener.apply(this,arguments)}},{key:"addEventListener",value:function(e,r){ne.includes(e)?this.ws.addEventListener(e,r):d(c(t.prototype),"on",this).call(this,e,r)}},{key:"removeEventListener",value:function(e,r){ne.includes(e)?this.ws.removeEventListener(e,r):d(c(t.prototype),"remove",this).call(this,e,r)}},{key:"close",value:function(){var e;(e=this.ws).close.apply(e,arguments)}}]),t}(ee))}();
